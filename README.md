# Redmine Monitoring

Плагин для Redmine, который перехватывает все ошибки приложения (включая HTTP-ошибки), метрики запросов и рекомендации 
по оптимизации (Bullet), сохраняет их в базу и предоставляет удобный интерфейс для просмотра.

## Возможности

- **Глобальный перехват ошибок** через middleware:
  - исключения (`StandardError`, `RuntimeError`, `ActiveRecord::RecordInvalid` и т.п.);
  - HTTP-статусы.
- **Сохранение информации** в таблицу `monitoring_errors`:
  - класс и сообщение ошибки;
  - backtrace;
  - контроллер/действие (`ProjectsController#index`);
  - статус ответа (`500`, `404` и др.);
  - пользователь (если авторизован);
  - параметры запроса (`params`);
  - заголовки (`headers`);
  - окружение (`Rails.env`);
  - IP, User-Agent, Referer.
- **Группировка ошибок**:
  - объединение однотипных ошибок в группы;
  - быстрый просмотр количества повторений;
  - фильтрация по классам ошибок, контроллерам, статусам и пользователям.
- **Метрики запросов**:
  - логирование всех входящих запросов;
  - метод, путь, формат, статус;
  - время выполнения (total/db/view);
  - размер ответа (`bytes_sent`);
  - связанный пользователь и IP.
- **Рекомендации (Bullet integration)**:
  - автоматическое сохранение подсказок Bullet (N+1, unused eager loading, counter cache);
  - привязка к запросу, контроллеру, пользователю;
  - удобный просмотр в отдельной вкладке.
- **UI в админке Redmine**:
  - вкладки: dashboard, ошибки, метрики, группы ошибок, рекомендации;
  - список с пагинацией и фильтрами (по пользователю, контроллеру, статусу и др.);
  - раскрытие деталей по клику;
  - подсветка и форматирование JSON (params, headers);
  - кнопка «копировать» для сниппетов.
- **Кнопки действий**:
  - «Создать тестовую ошибку»;
  - «Создать тестовую рекомендацию» (для Bullet);
  - «Очистить» (для ошибок, метрик, рекомендаций).
- **Настройки плагина**:
  - включение/выключение мониторинга;
  - режим разработки (включает Bullet-интеграцию и тестовые кнопки).

---

## Установка

1. Клонируйте репозиторий в каталог `plugins` Redmine:

   ```bash
   cd redmine/plugins
   git clone https://github.com/skyrusx/redmine_monitoring.git
   ```

2. Выполните миграции:

   ```bash
   bundle exec rake redmine:plugins:migrate
   ```

3. Перезапустите Redmine.

---

## Использование

- Перейдите в меню **Администрирование → Плагины → Redmine Monitoring plugin**.
- Включите мониторинг в настройках.
- Откройте страницу `/monitoring`, чтобы увидеть список ошибок.
- Используйте кнопку «Создать тестовую ошибку» для проверки.

---

## API / Технические детали

- Middleware `RedmineMonitoring::Middleware` ловит ошибки.
- Контроллер `MonitoringErrorsController`:
  - `index` — список ошибок;
  - `test_error` — создание тестовой ошибки;
  - `clear` — очистка всех ошибок (POST).
  - `test_reco` — создание тестовой рекомендации;
- Модель `MonitoringError` хранит все данные об ошибке.
- Модель `MonitoringRecommendation` хранит все данные о рекомендациях.
- Модель `MonitoringRequest` хранит все данные о метриках запросов.

---

## Настройки (settings)

- `enabled` — включить/выключить мониторинг (по умолчанию `true`).
- `dev_mode` — режим разработки (по умолчанию `false`).
- `max_errors` — максимальное количество ошибок, хранимых в базе (старые автоматически удаляются).
- `retention_days` — срок хранения ошибок и метрик в днях.
- `log_levels` — уровни логирования, которые будут сохраняться (например: `error`, `warning` и т. д.).
- `enabled_formats` — список форматов, для которых включён мониторинг (`html`, `json`, `xml` и т. д.).
- `enable_metrics` — включение сбора метрик запросов.
- `slow_request_threshold_ms` — порог (в миллисекундах) для пометки запроса как «медленного».

---

## Совместимость

- Redmine 4.x / 5.x  
- Ruby 2.6+  
- PostgreSQL / MySQL  

---

## Лицензия

[MIT](LICENSE.txt)
